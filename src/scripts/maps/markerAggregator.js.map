{"version":3,"sources":["markerAggregator.ts"],"names":["MarkerAggregator","MarkerAggregator.constructor","MarkerAggregator._setCurrentZoomLevel","MarkerAggregator.createCompositeMarkers","MarkerAggregator.addMarker","MarkerAggregator.getBaseMarkers"],"mappings":"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","file":"markerAggregator.js","sourcesContent":["/// <reference path=\"markerAggregator.d.ts\" />\n/// <reference path=\"others.d.ts\" />\n/* global L */\n\nimport D2tree from './D2tree.ts';\n\n(function(context){\n'use strict';\n\t\n\tclass MarkerAggregator implements IAggregator {\n\n\t\t// container with private vars\n\t\tprivate _map: IMap;\n\t\t// leaflet base markers\n\t\tprivate _baseMarkers = [];\n\t\t// leaflet composite markers\n\t\tprivate _compositeMarkers = {};\n\t\t// // coords, comments, etc. of base markers\n\t\t// private _baseMarkersData = [];\n\t\t// // coords, comments, etc. of composite markers\n\t\t// private _compositeMarkersData = [];\n\t\t// zoom level up to which (>=) base markers are displayed on the map\n\t\tprivate _baseZoom = 15;\n\t\t// zoom level below which (<=) new markera are not created \n\t\tprivate _minZoom = 7;\n\t\t// how much should zoom change to trigger markers change\n\t\tprivate _zoomStep = 1;\n\t\t// current zoom level\n\t\tprivate _currentZoomLevel;\n\t\t// size of the window to combine base markers at _baseZoom in degrees\n\t\tprivate _baseWindowSize = 0.005;\n\t\t// refference easter and southern marker of the aggregator\n\t\tprivate _eastSouth = null;\n\t\t// marker internal id\n\t\tprivate _id = 0;\n\t\t\n\t\tprivate _zoomLevels = {};\n\t\t\n\t\tprivate _setCurrentZoomLevel () {\n\t\t\tvar mapZoom = this._map.getZoom();\n\t\t\tif (mapZoom <= this._minZoom) { this._currentZoomLevel = this._minZoom}\n\t\t\telse if (mapZoom >= this._baseZoom) { this._currentZoomLevel = this._baseZoom}\n\t\t\telse {\n\t\t\t\tthis._currentZoomLevel = this._baseZoom  - Math.floor((this._baseZoom - mapZoom) / 2) * 2;\n\t\t\t}\n\t\t}\n\t\t\t\n\t\tconstructor (map: IMap, options: IAggregatorOptions) {\n\t\t\tif (options) {\n\t\t\t\tthis._map = map;\n\t\t\t\tthis._baseZoom = options.baseZoom || this._baseZoom;\n\t\t\t\tthis._zoomStep = options.zoomStep || this._zoomStep;\n\t\t\t\tthis._minZoom = options.minZoom || this._minZoom;\n\t\t\t\tthis._minZoom = this._baseZoom  - (this._baseZoom - this._minZoom) / 2 * 2;\n\t\t\t\tthis._baseWindowSize = options.baseWindowSize || this._baseWindowSize;\n\t\t\t}\n\t\t\t\n\t\t\tfor (var j=this._baseZoom-this._zoomStep; j>=this._minZoom; j-=this._zoomStep) {\n\t\t\t\tthis._zoomLevels[''+j] = {\n\t\t\t\t\twindowSize: this._baseWindowSize * Math.pow(1.7, this._baseZoom - j),\n\t\t\t\t\tmarkers: {}\n\t\t\t\t};\n\t\t\t}\nconsole.log(this._zoomLevels);\n\t\t\t\n\t\t\tthis._setCurrentZoomLevel();\nconsole.log(this._currentZoomLevel);\n\t\t}\n\t\t\n\t\tprivate createCompositeMarkers (baseMarkerRefLink: any) {\n// \t\t\t// apply changes to corresponding composite markers\n// \t\t\tvar latIndex: number, lngIndex: number;\n// \t\t\tvar compositeMarkerRef: any;\n// \t\t\t// for every zoom level\n// \t\t\tfor (var j=this._baseZoom-this._zoomStep; j>=this._minZoom; j-=this._zoomStep) {\n// \t\t\t\t// calculate composite marker's position\n// \t\t\t\tlatIndex = Math.floor((baseMarkerRefLink.getLatLng().lat - this._eastSouth.lat) / this._zoomLevels[''+j].windowSize);\n// \t\t\t\tlngIndex = Math.floor((baseMarkerRefLink.getLatLng().lng - this._eastSouth.lng) / this._zoomLevels[''+j].windowSize);\n// \t\t\t\tif (!this._zoomLevels[''+j].markers[latIndex+'|'+lngIndex] ||\n// \t\t\t\t\tthis._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].baseMarkers.length === 0) {\n// \t\t\t\t\t\tcompositeMarkerRef = L.marker([ baseMarkerRefLink.getLatLng().lat, baseMarkerRefLink.getLatLng().lng ]); \n// \t\t\t\t\t\t// first marker in this cell\n// \t\t\t\t\t\tthis._zoomLevels[''+j].markers[latIndex+'|'+lngIndex] = {\n// \t\t\t\t\t\t\tmarker: compositeMarkerRef,\n// \t\t\t\t\t\t\tbaseMarkers: [baseMarkerRefLink]\n// \t\t\t\t\t\t}\n// \t\t\t\t} else {\n// \t\t\t\t\t// save parameters of the old composite marker\n// \t\t\t\t\tvar counter = this._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].baseMarkers.length;\n// \t\t\t\t\tvar oldLat = this._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].marker.getLatLng().lat,\n// \t\t\t\t\t\toldLng = this._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].marker.getLatLng().lng;\n// \t\t\t\t\t// remove it from the map\n// \t\t\t\t\tthis._map.removeLayer(this._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].marker);\n// \t\t\t\t\t// insert new composite marker\n// \t\t\t\t\tthis._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].marker = compositeMarkerRef =\n// \t\t\t\t\t\tL.marker([ (baseMarkerRefLink.getLatLng().lat + oldLat*counter) / (counter+1),\n// \t\t\t\t\t\t\t\t\t(baseMarkerRefLink.getLatLng().lng + oldLng*counter) / (counter+1)\n// \t\t\t\t\t\t])\n// \t\t\t\t\t// reference to the base marker\n// \t\t\t\t\tthis._zoomLevels[''+j].markers[latIndex+'|'+lngIndex].baseMarkers.push(baseMarkerRefLink);\n// \t\t\t\t}\n// \t\t\t\t// check whether it's time to display current composite marker\n// \t\t\t\tif (j === this._currentZoomLevel) {\n// \t\t\t\t\tcompositeMarkerRef.addTo(this._map);\n// \t\t\t\t}\n// \t\t\t}\t\n\t\t}\n\t\t\n        public addMarker (coords: any): number {\n            return 0;\n        }\n// \t\t/*** add new leaflet marker to the aggregator \n// \t\t * @marker - leaflet marker object\n// \t\t * @return - number of base markers if successful, -1 if not\n// \t\t * because it uses eastern-southern point as a reference, it's better to start adding markers from\n// \t\t * the most easter and most southern markers to prevent general recalculation  \n// \t\t*/\n// \t\taddMarker (coords: any): number {\n// \t\t\tvar localCoords = {lat:0, lng:0};\n// \t\t\t// read coordinates \n// \t\t\tif (Array.isArray(coords) && coords.length >= 2 && typeof coords[0] === 'number' && typeof coords[1] === 'number') {\n// \t\t\t\tlocalCoords.lat = coords[0];\n// \t\t\t\tlocalCoords.lng = coords[1]; \n// \t\t\t} else if ((coords.lat || coords.lat === 0) && (coords.lng || coords.lng === 0)) {\n// \t\t\t\tlocalCoords.lat = coords.lat;\n// \t\t\t\tlocalCoords.lng = coords.lng; \n// \t\t\t} else {\n// \t\t\t\treturn -1;\n// \t\t\t}\n// \t\t\t// create base marker\n// \t\t\tvar baseMarkerRef = L.marker([localCoords.lat, localCoords.lng]);\n// \t\t\tbaseMarkerRef.aId = ++this._id;\n// \t\t\tthis._baseMarkers.push(baseMarkerRef);\n\t\t\t\n// \t\t\tvar basePointShift = false;\n// \t\t\t// calculate center using the first one\n// \t\t\tif (!this._eastSouth) {\n// \t\t\t\tthis._eastSouth = {\n// \t\t\t\t\tlat: localCoords.lat - 0.00001,\n// \t\t\t\t\tlng: localCoords.lng + 0.00001\n// \t\t\t\t}\n// \t\t\t} else if (this._eastSouth.lat >= localCoords.lat) {\n// \t\t\t\t// new base point\n// \t\t\t\tthis._eastSouth.lat = localCoords.lat - 0.00001;\n// \t\t\t\tbasePointShift = true;\n// \t\t\t} else if (this._eastSouth.lng <= localCoords.lng) {\n// \t\t\t\t// -//-\n// \t\t\t\tthis._eastSouth.lng = localCoords.lng + 0.00001;\n// \t\t\t\tbasePointShift = true;\n// \t\t\t}\n\t\t\t\n// \t\t\tif (basePointShift) {\n// \t\t\t\t// recalculate everything\n// \t\t\t\t// remove composite markers\n// \t\t\t\tfor (var j=this._baseZoom-this._zoomStep; j>=this._minZoom; j-=this._zoomStep) {\n// \t\t\t\t\t// markers on the current zoom layer (currently displayed) from the map\n// \t\t\t\t\tif (j === this._currentZoomLevel) {\n// \t\t\t\t\t\tfor (var k in this._zoomLevels[''+j].markers) {\n// \t\t\t\t\t\t\tthis._map.removeLayer(this._zoomLevels[''+j].markers[k].marker);\t\n// \t\t\t\t\t\t}\n// \t\t\t\t\t}\n// \t\t\t\t\t// from _zoomLevels\n// \t\t\t\t\tthis._zoomLevels[''+j] = {\n// \t\t\t\t\t\twindowSize: this._baseWindowSize * Math.pow(1.7, this._baseZoom - j),\n// \t\t\t\t\t\tmarkers: {}\n// \t\t\t\t\t};\n// \t\t\t\t}\n// \t\t\t\t// remove links to them from base markers\n// \t\t\t\t// for every existing base marker recalculate composite\n// \t\t\t\tfor (var j=0; j<this._baseMarkers.length; j++) {\n// \t\t\t\t\tthis.createCompositeMarkers(this._baseMarkers[j]);\n// \t\t\t\t}\n// \t\t\t} else {\n// \t\t\t\t// just add composite markers including given base marker\n// \t\t\t\tthis.createCompositeMarkers(baseMarkerRef);\t\n// \t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n \n// \t\t\tif (this._currentZoomLevel === this._baseZoom) {\n// \t\t\t\t// display base marker\n// \t\t\t\tbaseMarkerRef.addTo(this._map);\n// \t\t\t}\n\n// \t\t\t// return new base marker id\n// \t\t\treturn baseMarkerRef.aId;\n// \t\t}\n\t\t/*** return base markers */\n\t\tgetBaseMarkers (): any [] {\n\t\t\treturn this._baseMarkers;\n\t\t}\n// \t\t/*** start listen for map's zoom change */\n// \t\tstart (): void {\n// \t\t\tvar self = this;\n// console.log('inside start');\t\t\n// \t\t\tfunction rerender () {\n// console.log('inside rerender');\n// \t\t\t\t// store old zoom level and calculate new one\n// \t\t\t\tvar oldZoom = self._currentZoomLevel;\n// \t\t\t\tvar i;\n// \t\t\t\tself._setCurrentZoomLevel();\n// console.log(oldZoom, self._currentZoomLevel);\n// \t\t\t\tif (oldZoom !== self._currentZoomLevel) {\n// \t\t\t\t\t// need to display different group of markers\n// \t\t\t\t\t// hide old\n// \t\t\t\t\tif (oldZoom === self._baseZoom) {\n// \t\t\t\t\t\t// hide base markers\n// \t\t\t\t\t\tfor (i=0; i<self._baseMarkers.length; i++) {\n// \t\t\t\t\t\t\tself._map.removeLayer(self._baseMarkers[i]);\n// \t\t\t\t\t\t}\n// \t\t\t\t\t} else {\n// \t\t\t\t\t\t// hide composite markers\n// \t\t\t\t\t\tfor (var key in self._zoomLevels[''+oldZoom].markers) {\n// \t\t\t\t\t\t\tself._map.removeLayer(self._zoomLevels[''+oldZoom].markers[key].marker);\n// \t\t\t\t\t\t}\n// \t\t\t\t\t}\t\t\n// \t\t\t\t\t// display new\n// \t\t\t\t\tif (self._zoomLevels[''+self._currentZoomLevel]) {\n// \t\t\t\t\t\t// composite markers\n// \t\t\t\t\t\tfor (var key in self._zoomLevels[''+self._currentZoomLevel].markers) {\n// \t\t\t\t\t\t\tself._zoomLevels[''+self._currentZoomLevel].markers[key].marker.addTo(self._map);\n// \t\t\t\t\t\t}\n// \t\t\t\t\t} else {\n// \t\t\t\t\t\t// base markers\n// \t\t\t\t\t\tfor (i=0; i<self._baseMarkers.length; i++) {\n// \t\t\t\t\t\t\tself._baseMarkers[i].addTo(self._map);\n// \t\t\t\t\t\t}\n// \t\t\t\t\t}\n\t\t\t\t\t\n// \t\t\t\t}\n// \t\t\t}\n// \t\t\tthis._map.on('zoomend', rerender);\n// \t\t}\n// \t\t/*** stop listen for map's zoom change */\n// \t\tstop (): void {\n\t\t\t\n// \t\t}\n\t}\n\n\t// inject\n\tcontext.MarkerAggregator = MarkerAggregator;\n    context.D2tree = D2tree;\n\n}(window));"],"sourceRoot":"/source/"}